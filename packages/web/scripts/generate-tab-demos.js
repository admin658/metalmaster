const fs = require('fs');
const path = require('path');

/**
 * Utility to prettify file names for display.
 * e.g. "metallica-master_of_puppets.gp5" -> "Metallica Master Of Puppets (GP5)"
 */
function toLabel(fileName) {
  const ext = path.extname(fileName);
  const base = path.basename(fileName, ext);
  const words = base
    .replace(/[-_]+/g, ' ')
    .replace(/([a-z])([A-Z])/g, '$1 $2')
    .replace(/([A-Za-z])([0-9])/g, '$1 $2')
    .replace(/([0-9])([A-Za-z])/g, '$1 $2')
    .replace(/\s+/g, ' ')
    .trim()
    .split(' ')
    .filter(Boolean)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1));
  const label = words.join(' ');
  return `${label} (${ext.replace('.', '').toUpperCase()})`;
}

function collectFiles(relativeDir) {
  const dir = path.join(__dirname, '..', 'public', relativeDir);
  if (!fs.existsSync(dir)) return [];
  return fs
    .readdirSync(dir)
    .filter(file => /\.(gp3|gp4|gp5|gpx|alphatab|alphatex)$/i.test(file))
    .map(file => ({
      label: toLabel(file),
      path: `/${relativeDir}/${file}`,
      description: '',
    }));
}

function main() {
  const tabs = collectFiles('tabs');
  const lessons = collectFiles('lessons');
  const demoFiles = [...tabs, ...lessons].sort((a, b) => a.label.localeCompare(b.label));

  const outputPath = path.join(
    __dirname,
    '..',
    'src',
    'app',
    'tab-player',
    'demoFiles.generated.ts'
  );

  const banner = [
    '// Auto-generated by scripts/generate-tab-demos.js',
    '// Do not edit manually. Run `yarn workspace @metalmaster/web run generate:tab-demos` to regenerate.',
    '',
  ].join('\n');

  const contents = `${banner}export type GeneratedDemoFile = { label: string; path: string; description?: string; backingUrl?: string; };\nexport const demoFiles: GeneratedDemoFile[] = ${JSON.stringify(
    demoFiles,
    null,
    2
  )};\n`;

  fs.mkdirSync(path.dirname(outputPath), { recursive: true });
  fs.writeFileSync(outputPath, contents, 'utf8');
  console.log(`Wrote ${demoFiles.length} demo entries to ${path.relative(process.cwd(), outputPath)}`);
}

main();
